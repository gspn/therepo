#!/usr/bin/env bash
set -euo pipefail

# Ensure this is a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
  echo "Error: Not inside a git repository."
  exit 1
fi

# Determine current branch
branch=$(git rev-parse --abbrev-ref HEAD)

echo "Current branch: $branch"

# Collect all modified or untracked files
mapfile -t files < <(git ls-files --others --modified --exclude-standard)

if [ ${#files[@]} -eq 0 ]; then
  echo "No changed or untracked files to commit."
  exit 0
fi

echo "Found ${#files[@]} files to process."

# Process files in chunks of $1
for ((i=0; i<${#files[@]}; i+=$1)); do
  chunk=( "${files[@]:i:$1}" )
  start=$((i+1))
  end=$((i+${#chunk[@]}))
  echo "\nStaging files $start to $end..."
  git add "${chunk[@]}"

  commit_msg="Batch commit: files $start to $end"
  echo "Committing: $commit_msg"
  git commit -m "$commit_msg"

  echo "Pushing commit $((i/$1+1)) to origin/$branch..."
  git push origin "$branch"
done

echo "All batches committed and pushed."